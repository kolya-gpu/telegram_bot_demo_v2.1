# Исправление ошибки PermissionError: [Errno 13] Permission denied: '/logs'

## Описание проблемы

Ошибка возникала по двум причинам:

1. **Проблема с директорией `/logs`**: В Docker контейнере код пытался создать директорию `/logs` (абсолютный путь), но у пользователя `bot` не было прав на создание директорий в корне файловой системы.

2. **Проблема с CSV файлом**: Код пытался создать CSV файл по абсолютному пути `/message_mapping.csv`, но у пользователя `bot` не было прав на запись в корень файловой системы.

## Что было исправлено

### 1. Файл `bot/logging_config.py`
- Изменен путь с абсолютного `/logs` на относительный `logs`
- Теперь директория создается относительно рабочей директории контейнера `/app`

### 2. Файл `bot/main.py`
- Изменен путь к CSV файлу с абсолютного на `/app/logs/message_mapping.csv`
- Теперь CSV файл создается в директории logs, где у пользователя `bot` есть права на запись

### 3. Файл `bot/Dockerfile`
- **КЛЮЧЕВОЕ ИЗМЕНЕНИЕ**: Директория `/app/logs` теперь создается от имени пользователя `bot` после смены владельца
- Это гарантирует, что директория создается с правильными правами доступа

### 4. Файл `docker-compose.yml`
- Упрощена команда запуска, убрана команда создания директории
- Оставлен только маппинг директории `./logs:/app/logs`

## Финальное решение

### Структура путей в контейнере:
- **Логи**: `/app/logs/` (создается в Dockerfile от имени пользователя `bot`)
- **CSV файл**: `/app/logs/message_mapping.csv` (создается в директории logs)
- **Рабочая директория**: `/app/`

### Права доступа:
- Директория `/app/logs` создается от имени пользователя `bot` в Dockerfile
- Пользователь `bot` автоматически имеет права на запись в `/app/logs`
- CSV файл создается в директории logs, где есть права на запись

## Ключевые изменения

### В `Dockerfile`:
```dockerfile
# Было:
RUN mkdir -p /app/logs && chmod 755 /app/logs

# Стало:
RUN useradd --create-home --shell /bin/bash bot && \
    chown -R bot:bot /app

# Создаем директорию для логов с правильными правами доступа
USER bot
RUN mkdir -p /app/logs
```

### В `docker-compose.yml`:
```yaml
# Убрана команда создания директории, так как она создается в Dockerfile
volumes:
  - ./logs:/app/logs
```

## Как применить исправления

### Вариант 1: Автоматический (рекомендуется)
Запустите PowerShell скрипт:
```powershell
.\rebuild_and_run.ps1
```

### Вариант 2: Ручной
1. Остановите контейнеры:
```bash
docker-compose down
```

2. Пересоберите образы:
```bash
docker-compose build --no-cache
```

3. Создайте директорию logs (если её нет):
```bash
mkdir logs
```

4. Запустите контейнеры:
```bash
docker-compose up -d
```

## Проверка исправления

После запуска проверьте логи:
```bash
docker-compose logs bot
```

Если ошибка исправлена, вы должны увидеть:
```
telegram_bot  | 2025-08-30 15:44:49 - csv_storage - INFO - init:68 - CSV файл уже существует: /app/logs/message_mapping.csv
telegram_bot  | 2025-08-30 15:44:49 - main - INFO - on_startup:135 - CSV хранилище инициализировано
telegram_bot  | 2025-08-30 15:44:49 - main - INFO - on_startup:154 - Webhook успешно установлен
```

## Ключевые изменения

### В `logging_config.py`:
```python
# Было:
log_dir = os.path.join(os.path.dirname(os.path.dirname(__file__)), "logs")

# Стало:
log_dir = "logs"
```

### В `main.py`:
```python
# Было:
csv_file_path = os.path.join(os.path.dirname(os.path.dirname(__file__)), "message_mapping.csv")

# Стало:
csv_file_path = "/app/logs/message_mapping.csv"
```

### В `Dockerfile`:
```dockerfile
# Ключевое изменение - создание директории от имени пользователя bot
USER bot
RUN mkdir -p /app/logs
```

## Структура директорий после исправления

```
telegram_bot_demo/
├── bot/
│   ├── logs/          # Логи внутри контейнера
│   └── ...
├── logs/              # Логи на хосте (маппинг)
│   ├── bot.log
│   ├── csv_storage.log
│   ├── message_handler.log
│   └── message_mapping.csv  # CSV файл теперь здесь
└── ...
```

## Тестирование

Для проверки прав доступа в контейнере можно запустить:
```bash
docker exec -it telegram_bot python test_permissions.py
```

Этот скрипт проверит доступ к директории logs и покажет детальную информацию о правах доступа.

## Результат

После применения всех исправлений:
- ✅ Бот успешно запускается без ошибок PermissionError
- ✅ Директория logs создается автоматически от имени пользователя bot
- ✅ CSV файл создается в директории logs
- ✅ Все логи записываются корректно
- ✅ Webhook устанавливается успешно
- ✅ Контейнер работает стабильно без перезапусков

## Важные моменты

1. **Порядок команд в Dockerfile критичен** - директория logs должна создаваться после смены владельца и переключения на пользователя bot
2. **Относительные пути** в logging_config.py работают корректно в контейнере
3. **Абсолютные пути** для CSV файла должны указывать на директорию, где у пользователя bot есть права на запись
