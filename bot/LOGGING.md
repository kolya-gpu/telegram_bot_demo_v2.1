# Логирование Telegram бота

## Обзор

Бот настроен с детальным логированием в файлы для отслеживания всех операций и отладки проблем.

## Структура логов

Логи сохраняются в директории `logs/` в корне проекта:

```
logs/
├── bot.log              # Основные логи бота (10MB)
├── csv_storage.log      # Логи CSV хранилища (5MB)
├── message_handler.log  # Логи обработчика сообщений (5MB)
└── nginx/               # Логи nginx (если используется)
```

## Файлы логов

### 1. bot.log
- Запуск и остановка бота
- Настройка webhook
- Обработка входящих сообщений
- Общие ошибки

### 2. csv_storage.log
- Операции с CSV файлом
- Сохранение маппингов сообщений
- Поиск пользователей по ID сообщений
- Ошибки чтения/записи

### 3. message_handler.log
- Обработка сообщений от пользователей
- Пересылка в канал
- Обработка ответов из канала
- Пересылка ответов пользователям

## Ротация логов

- **bot.log**: максимум 10MB, 5 файлов резервных копий
- **csv_storage.log**: максимум 5MB, 3 файла резервных копий
- **message_handler.log**: максимум 5MB, 3 файла резервных копий

При достижении лимита создается новый файл с суффиксом `.1`, `.2` и т.д.

## Формат логов

```
2025-01-27 15:30:45 - module_name - INFO - function_name:line_number - message
```

Пример:
```
2025-01-27 15:30:45 - main - INFO - on_startup:95 - Бот запускается...
2025-01-27 15:30:45 - csv_storage - INFO - init:65 - CSV хранилище инициализировано
```

## Уровни логирования

- **INFO**: Обычные операции, успешные действия
- **WARNING**: Предупреждения, не критичные проблемы
- **ERROR**: Ошибки, требующие внимания
- **DEBUG**: Детальная отладочная информация (не используется по умолчанию)

## Отладка проблем

### Проблема с ответами из канала

1. Проверьте `message_handler.log`:
   ```
   grep "Получен ответ в канале" logs/message_handler.log
   ```

2. Проверьте `csv_storage.log`:
   ```
   grep "Ищем пользователя для channel_message_id" logs/csv_storage.log
   ```

3. Проверьте `bot.log`:
   ```
   grep "Обрабатываем сообщение из канала" logs/bot.log
   ```

### Проблема с сохранением маппингов

1. Проверьте `csv_storage.log`:
   ```
   grep "Сохраняем маппинг" logs/csv_storage.log
   ```

2. Проверьте права доступа к файлу:
   ```
   ls -la logs/
   ```

## Настройка логирования

### Изменение уровня логирования

В файле `logging_config.py` измените:
```python
logger.setLevel(logging.DEBUG)  # Для детального логирования
```

### Изменение размера файлов

В файлах модулей измените параметр `max_bytes`:
```python
logger = setup_logging("module_name", "filename.log", 20*1024*1024)  # 20MB
```

### Отключение консольного вывода

В `logging_config.py` закомментируйте:
```python
# logger.addHandler(console_handler)
```

## Мониторинг логов

### Просмотр логов в реальном времени

```bash
# Основные логи
tail -f logs/bot.log

# Логи CSV хранилища
tail -f logs/csv_storage.log

# Логи обработчика сообщений
tail -f logs/message_handler.log
```

### Поиск по логам

```bash
# Поиск ошибок
grep "ERROR" logs/*.log

# Поиск по пользователю
grep "user_id=1639019765" logs/*.log

# Поиск по времени
grep "2025-01-27 15:30" logs/*.log
```

### Анализ размера логов

```bash
# Размер всех файлов логов
du -sh logs/*.log

# Количество строк в каждом файле
wc -l logs/*.log
```

## Очистка логов

### Автоматическая очистка

Логи автоматически ротируются при достижении лимита размера.

### Ручная очистка

```bash
# Очистка всех логов
> logs/bot.log
> logs/csv_storage.log
> logs/message_handler.log

# Удаление старых резервных копий
rm logs/*.log.*
```

## Устранение неполадок

### Логи не создаются

1. Проверьте права доступа к директории `logs/`
2. Убедитесь, что директория существует
3. Проверьте свободное место на диске

### Дублирование логов

1. Проверьте, что в каждом модуле используется только один логгер
2. Убедитесь, что не настроено несколько обработчиков

### Слишком большие файлы логов

1. Уменьшите размер файлов в настройках
2. Увеличьте частоту ротации
3. Добавьте фильтрацию по важности сообщений
