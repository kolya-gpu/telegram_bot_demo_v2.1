# üèóÔ∏è –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã Telegram Bot —Å CSV —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º

## üìã –û–±—â–∏–π –æ–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

```mermaid
graph TB
    subgraph "TELEGRAM API"
        U1[User 1<br/>123456789]
        U2[User 2<br/>987654321]
        U3[User N<br/>555666777]
        
        M1[Message 1<br/>Text/Photo/Video]
        M2[Message 2<br/>Video/Doc/Audio]
        M3[Message N<br/>Audio/Voice/etc]
        
        U1 --> M1
        U2 --> M2
        U3 --> M3
    end
    
    subgraph "NGINX (Reverse Proxy) ‚Äî webhook —Ä–µ–∂–∏–º"
        SSL[SSL Certificates<br/>cert.pem + key.pem]
        PROXY[HTTPS ‚Üí HTTP<br/>Port 8000]
    end
    
    subgraph "BOT SERVICE (Python)"
        MAIN[main.py<br/>Entry Point]
        HANDLER[message_handler.py<br/>Message Processing]
        CSV[csv_storage.py<br/>CSV Operations]
        
        MAIN --> HANDLER
        HANDLER --> CSV
    end
    
    subgraph "CSV STORAGE"
        FILE[message_mapping.csv<br/>Data File]
        STRUCT[Structure:<br/>user_id,user_message_id,<br/>channel_message_id,<br/>created_at,user_name]
    end
    
    subgraph "TELEGRAM CHANNEL"
        IN[Incoming Messages<br/>üë§ From Users]
        OUT[Admin Replies<br/>üì¢ To Users]
    end
    
    M1 --> SSL
    M2 --> SSL
    M3 --> SSL
    
    SSL --> PROXY
    PROXY --> MAIN

    %% –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: long polling (–±–µ–∑ Nginx)
    T -. polling .-> MAIN
    
    CSV --> FILE
    FILE --> STRUCT
    
    MAIN --> IN
    OUT --> MAIN
```

## üîÑ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

### 1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –ë–æ—Ç**

```mermaid
sequenceDiagram
    participant U as User
    participant T as Telegram API
    participant N as Nginx
    participant B as Bot Service
    participant C as CSV Storage
    participant CH as Channel
    
    U->>T: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
    T->>N: Webhook POST /webhook
    N->>B: HTTP Request (Port 8000)
    B->>B: main.py: handle_message()
    B->>B: message_handler.py: handle_user_message()
    B->>CH: –ü–µ—Ä–µ—Å—ã–ª–∫–∞ –≤ –∫–∞–Ω–∞–ª
    B->>C: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∞–ø–ø–∏–Ω–≥–∞
    C->>C: –ó–∞–ø–∏—Å—å –≤ CSV
    B->>U: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
```

### 2. **–ö–∞–Ω–∞–ª ‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**

```mermaid
sequenceDiagram
    participant A as Admin
    participant CH as Channel
    participant T as Telegram API
    participant N as Nginx
    participant B as Bot Service
    participant C as CSV Storage
    participant U as User
    
    A->>CH: –û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
    T->>N: Webhook —Å –æ—Ç–≤–µ—Ç–æ–º
    N->>B: HTTP Request
    B->>B: main.py: handle_message()
    B->>B: message_handler.py: handle_channel_reply()
    B->>C: –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    C->>C: –ß—Ç–µ–Ω–∏–µ CSV
    C->>B: user_id –Ω–∞–π–¥–µ–Ω
    B->>U: –ü–µ—Ä–µ—Å—ã–ª–∫–∞ –æ—Ç–≤–µ—Ç–∞
```

## üèõÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### **main.py** - –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
```python
# –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
‚îú‚îÄ‚îÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ Bot –∏ Dispatcher
‚îú‚îÄ‚îÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è CSV —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
‚îú‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ MessageHandler
‚îú‚îÄ‚îÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook
‚îú‚îÄ‚îÄ –ó–∞–ø—É—Å–∫ HTTP —Å–µ—Ä–≤–µ—Ä–∞
‚îî‚îÄ‚îÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ startup/shutdown
```

### **message_handler.py** - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
```python
# –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
‚îú‚îÄ‚îÄ handle_user_message()
‚îÇ   ‚îú‚îÄ‚îÄ –ü–µ—Ä–µ—Å—ã–ª–∫–∞ –≤ –∫–∞–Ω–∞–ª
‚îÇ   ‚îú‚îÄ‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ CSV
‚îÇ   ‚îî‚îÄ‚îÄ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
‚îú‚îÄ‚îÄ handle_channel_reply()
‚îÇ   ‚îú‚îÄ‚îÄ –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ CSV
‚îÇ   ‚îî‚îÄ‚îÄ –ü–µ—Ä–µ—Å—ã–ª–∫–∞ –æ—Ç–≤–µ—Ç–∞
‚îî‚îÄ‚îÄ _forward_reply_to_user()
    ‚îú‚îÄ‚îÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    ‚îî‚îÄ‚îÄ –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```

### **csv_storage.py** - CSV —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
```python
# –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
‚îú‚îÄ‚îÄ init() - –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
‚îú‚îÄ‚îÄ save_message_mapping() - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ get_user_by_channel_message() - –ü–æ–∏—Å–∫
‚îú‚îÄ‚îÄ get_user_message_id() - –ü–æ–ª—É—á–µ–Ω–∏–µ ID
‚îú‚îÄ‚îÄ get_all_mappings() - –í—Å–µ –∑–∞–ø–∏—Å–∏
‚îî‚îÄ‚îÄ close() - –ó–∞–∫—Ä—ã—Ç–∏–µ
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ CSV —Ñ–∞–π–ª–∞

```csv
user_id,user_message_id,channel_message_id,created_at,user_name
123456789,111,222,2024-01-01T12:00:00,John
987654321,333,444,2024-01-01T12:01:00,Jane
555666777,555,666,2024-01-01T12:02:00,Bob
```

### **–ü–æ–ª—è CSV:**
- **user_id**: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
- **user_message_id**: ID —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **channel_message_id**: ID —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª–µ
- **created_at**: –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ (ISO format)
- **user_name**: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### **scripts/test-bot.py**
```python
# –¢–µ—Å—Ç—ã:
‚îú‚îÄ‚îÄ test_environment() - –ü—Ä–æ–≤–µ—Ä–∫–∞ .env
‚îú‚îÄ‚îÄ test_bot_token() - –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
‚îî‚îÄ‚îÄ test_csv_storage() - –¢–µ—Å—Ç CSV —Ñ—É–Ω–∫—Ü–∏–π
    ‚îú‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    ‚îú‚îÄ‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞
    ‚îú‚îÄ‚îÄ –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    ‚îú‚îÄ‚îÄ –ü–æ–¥—Å—á–µ—Ç –∑–∞–ø–∏—Å–µ–π
    ‚îî‚îÄ‚îÄ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å `asyncio.Lock`
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ graceful fallback
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –¢–æ–ª—å–∫–æ ID —Å–æ–æ–±—â–µ–Ω–∏–π (–±–µ–∑ –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏)

### **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- ‚ö° –ë—ã—Å—Ç—Ä–æ–µ —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å CSV
- ‚ö° –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
- ‚ö° –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚ö° –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Nginx

## üìà –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### **–¢–µ–∫—É—â–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- ‚úÖ –î–æ 10,000 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å
- ‚úÖ –î–æ 1,000 –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–ª–∏–∫ (< 100ms)

### **–î–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è:**
1. **–ê—Ä—Ö–∏–≤–∞—Ü–∏—è**: –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
2. **–ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ**: –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–æ –∫–ª—é—á–µ–≤—ã–º –ø–æ–ª—è–º
3. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ**: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ CSV –ø–æ –¥–∞—Ç–∞–º/–º–µ—Å—è—Ü–∞–º
4. **–ú–∏–≥—Ä–∞—Ü–∏—è**: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ PostgreSQL –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
5. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: Redis –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –º–∞–ø–ø–∏–Ω–≥–æ–≤

## üöÄ –ó–∞–ø—É—Å–∫ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### **–ö–æ–º–∞–Ω–¥—ã –∑–∞–ø—É—Å–∫–∞:**
```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose up -d

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker-compose logs -f bot

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
python scripts/test-bot.py

# –ü—Ä–æ—Å–º–æ—Ç—Ä CSV –¥–∞–Ω–Ω—ã—Ö
cat message_mapping.csv
```

### **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
- üìä –†–∞–∑–º–µ—Ä CSV —Ñ–∞–π–ª–∞
- üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
- üìä –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –±–æ—Ç–∞
- üìä –õ–æ–≥–∏ –æ—à–∏–±–æ–∫ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π

## üîÑ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –∏ –º–∏–≥—Ä–∞—Ü–∏—è

### **–ö–æ–≥–¥–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ PostgreSQL:**
- üìà > 100,000 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å
- üìà > 10,000 –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- üìà –ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- üìà –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ ACID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º

### **–ü—Ä–æ—Ü–µ—Å—Å –º–∏–≥—Ä–∞—Ü–∏–∏:**
1. –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV
2. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ PostgreSQL
3. –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
6. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### **–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**
- üîç –ü–æ–∏—Å–∫ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏–π
- üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- üö´ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–ø–∞–º-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- üìù –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–≤–µ—Ç—ã
- üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
- üì± –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
